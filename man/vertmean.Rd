% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/vertmean.R
\name{vertmean}
\alias{vertmean}
\title{Vertical Volume Weighted Mean of Matter Concentrations in Water Bodies}
\usage{
vertmean(depth, variable, level, top, bot, vol, total = FALSE)
}
\arguments{
\item{depth}{sorted vector of sampled depths.}

\item{variable}{measurements corresponding to \code{depth} (concentration,
temperature, \dots).}

\item{level}{surface water level (above ground or above sea level (m
a.s.l.), depending on bathymetric function used.}

\item{top}{top water level of requested layer over which to average or
integrate.}

\item{bot}{bottom water level of requested layer over which to average or
intgrate.}

\item{vol}{hypsographic function to be used (e.g. \code{vol.depth}). This
function must accept two arguments: a depth or vector of depths, and the
\code{level} argument, and it must return the cumulative volume from the
surface down to the specified depth(s).}

\item{total}{if \code{TRUE} the total sum over the water body is
returned (integrated value), instead of the volumetric mean.}
}
\value{
Volumetric average respectively total value (for total =\code{TRUE}) for a
given quantity (concentration, energy, temperature) in the requested
layer between depths \code{top} and \code{bottom}. Returns \code{NaN} if no data
points are within the specified depth range or if the total volume is zero.
}
\description{
Calculate vertical mean values which respect to depths of different
layers or lake morphometry.
}
\details{
This function calculates the vertical volumetric weighted mean of a variable
(e.g., concentration, temperature) within a specified depth range of a water body.
It uses a provided hypsographic function (\code{vol}) to determine the volume of water
at different depths, allowing for weighting the variable by the volume of the
corresponding layer.

The function first selects the data points (\code{depth} and \code{variable}) that fall within
the specified \code{top} and \code{bot} depths. It then defines layers for volume calculation
using the \code{top}, \code{bot}, and the midpoints between consecutive selected \code{depth} values.
The \code{vol} function is called to calculate the cumulative volume at these layer
boundaries. The volume of each layer is then determined from the differences in
cumulative volume.

The weighted mean is calculated as the sum of (variable value * layer volume)
divided by the total volume of the specified layer. If \code{total} is set to \code{TRUE},
the function returns the total sum (integrated value) instead of the mean.

Argument validation is performed at the beginning of the function to ensure
that the inputs are of the expected types and structures, and that the
\code{top} depth is not greater than the \code{bot} depth. Warnings are issued if no
data points are found within the specified depth range or if the total volume
of the layer is zero.
}
\examples{

## define a bathymetric formula for a given lake or basin
## z:     water depth  (m below surface)
## zz:    water column (m above ground)
## level: total water depth (m above ground or above reference level)
weight.vol <- function(z, level) {
  zz  <- level - z
  if (any(zz < 0)) stop("depth > maximum depth")
  vol <- 175947 * zz^2 + 2686 * zz^3 # m^3
}

## area is first derivative (not directly used in vertmean, but related)
area <- function(z, level) {
  zz  <- level - z
  A   <-   0.5 * 175947 * zz + 1/3 * 2686 * zz^2 # m^2
}

## dummy formula for depth-weighted averaging
## (water column, instead of bathymetric curve)

weight.column <- function(z, level) {z}

## Plot of lake volume (bathymetric curve)
par(mfrow = c(1, 2))
z <- 0:12
V <- weight.vol(z, 12)
plot(V, z, type = "l", ylim = c(12, 0), xlab = "Volume (m3)",
  ylab = "Depth (m)")
polygon(c(V, 0), c(z, 0), col = "cyan")

## Test Data
level <- 12
depth <- c(0, 1, 3.5, 5, 7, 10, 10.5, 11.5)
pconc <- c(3.7, 4.2, 6.1, 8.9, 7.8, 9.7, 11.4, 11.4)

## Plot test data
plot(pconc, depth, xlim=range(c(0, pconc)), ylim=c(12,0), type="n",
  xlab="P concentration (mu g / L)", ylab="Depth (m)")
segments(rep(0, 13), depth, pconc, depth, lwd=3)

## simple means
m <- mean(pconc[depth <= 4])
lines(c(m, m), c(0, 4), col="blue", lwd=2)

m <- mean(pconc[depth >= 4])
lines(c(m, m), c(4, 12), col="blue", lwd=2)

## depth weighted
m <- vertmean(depth, pconc, level, top=0, bot=4, weight.column)
lines(c(m, m), c(0, 4), col="red", lwd=2)

m <- vertmean(depth, pconc, level, top=4, bot=12, weight.column)
lines(c(m, m), c(4, 12), col="red", lwd=2)

## volume weighted
m <- vertmean(depth, pconc, level, top=0, bot=4, weight.vol)
lines(c(m, m), c(0, 4), col="green", lwd=2)

m <- vertmean(depth, pconc, level, top=4, bot=12, weight.vol)
lines(c(m, m), c(4, 12), col="green", lwd=2)

m <- vertmean(depth, pconc, level, top=4, bot=12, weight.vol)
lines(c(m, m), c(4, 12), col="green", lwd=2)

legend("topright", col=c("blue", "red", "green"), lwd=2, cex=0.7,
  legend=c("non weighted", "depth weighted", "volume weighted"))

## total sum over the whole water column
vertmean(depth, pconc, level, top=0, bot=12, weight.vol, total=TRUE)

}
\author{
Thomas Petzoldt
}
\keyword{misc}
